<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#FFB7C5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è·¨å¹´é¦™æ¸¯è¡Œ">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>2025 å°åŒ—é¼»è·¨å¹´é¦™æ¸¯è¡Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Itim&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. æ•´é«”é¢¨æ ¼å®šç¾© (ç²‰ç´…æ‰‹å¸³é¢¨) --- */
        :root {
            --primary-color: #FF9EAA; 
            --primary-dark: #FF708D;  
            --accent-color: #FFF0F5;  
            --text-color: #5D4037;    
            --card-bg: rgba(255, 255, 255, 0.96);
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Itim', 'Noto Sans TC', cursive, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--accent-color);
            background-image: url('pattern.png'); 
            background-repeat: repeat;
            background-size: 400px; 
            background-position: top center;
            color: var(--text-color);
            padding-bottom: calc(var(--nav-height) + 30px); 
            font-size: 16px;
            min-height: 100vh;
        }

        /* æ¨™é¡Œåˆ— */
        header {
            background: rgba(255, 255, 255, 0.95); 
            padding: 15px 10px; 
            text-align: center;
            border-bottom-left-radius: 25px; 
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(255, 158, 170, 0.2); 
            position: sticky; top: 0; z-index: 100;
            border-bottom: 3px solid var(--primary-color);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ· */
        }
        
        h1 { 
            margin: 0; font-size: 1.25rem; color: var(--text-color); 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            letter-spacing: 1px; flex-grow: 1;
        }
        
        .header-icon { 
            height: 40px; width: auto; object-fit: contain; 
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1));
        }

        /* è¨­å®šæŒ‰éˆ• */
        .settings-btn {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px;
            box-shadow: none;
            margin-top: calc(env(safe-area-inset-top) / 2);
        }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(100, 100, 100, 0.05); 
            border: 2px solid white; 
            position: relative;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: var(--primary-color); color: white; border: none; padding: 10px 18px;
            border-radius: 50px; font-family: inherit; cursor: pointer; font-size: 0.95rem;
            box-shadow: 0 3px 8px rgba(255, 112, 141, 0.3); transition: 0.2s;
            font-weight: bold;
        }
        button:active { transform: scale(0.96); }
        button.secondary { background-color: #FFCC80; color: #5D4037; }
        button.danger { background-color: #EF9A9A; }
        button.outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); box-shadow: none; }
        button.icon-btn { padding: 5px 10px; border-radius: 12px; font-size: 1.1rem; }
        button.full-width { width: 100%; margin-top: 15px; padding: 12px; }

        /* è¼¸å…¥æ¡† */
        input, textarea, select {
            width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 2px solid #F8E1E6;
            border-radius: 15px; font-family: inherit; background: #fff; color: #555;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary-color); }
        textarea { resize: vertical; min-height: 80px; }
        label { font-weight: bold; color: var(--primary-dark); font-size: 0.95rem; display: block; margin-top: 10px; margin-bottom: 3px;}
        
        /* åº•éƒ¨å°èˆª (ç™½åº•åœ“è§’) */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px; height: var(--nav-height);
            background: #FFFFFF; 
            display: flex; overflow-x: auto; align-items: center; justify-content: space-around;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1); z-index: 1000; padding: 0 5px;
            border-radius: 25px; 
            border: 1px solid rgba(0,0,0,0.02);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-nav::-webkit-scrollbar { display: none; }
        
        .nav-item {
            flex: 1; text-align: center; padding: 8px; font-size: 0.75rem;
            color: #AAA; cursor: pointer; border-radius: 18px; margin: 0 2px; 
            transition: 0.2s; min-width: 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item.active { 
            background-color: #FFF0F5; color: var(--primary-dark); font-weight: bold; 
            transform: translateY(-3px);
        }
        .nav-icon-img { 
            width: 32px; height: 32px; object-fit: contain; margin-bottom: 4px; display: block; 
        }

        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* è³‡è¨Šåˆ— */
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #FFCDD2; padding: 10px 0; align-items: baseline; }
        .info-label { color: #9FA8DA; font-size: 0.9rem; min-width: 90px; }
        .info-value { font-weight: 500; text-align: right; flex-grow: 1; word-break: break-all; color: #555;}
        .section-title { 
            color: var(--text-color); background: #FFF9C4; 
            padding: 6px 18px; border-radius: 20px;
            margin-bottom: 15px; margin-top: 25px; display: inline-block; font-size: 1.1rem; 
            box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }
        .edit-controls { text-align: right; margin-bottom: 10px; }
        .edit-group { background: #FFFBFC; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px dashed #F8E1E6; position: relative; }
        .delete-btn-corner { position: absolute; top: -10px; right: -5px; font-size: 0.8rem; background: #FF8A80; color: white; padding: 4px 8px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        
        /* åœ–ç‰‡é¡¯ç¤º */
        .preview-img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 12px; margin-top: 8px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; margin-top: 5px;}
        .upload-btn-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;}
        
        /* è¡Œç¨‹æ™‚é–“è»¸ */
        .day-header { 
            background: linear-gradient(135deg, #FF9EAA, #FFC1CC); 
            color: white; padding: 12px 20px; border-radius: 15px; 
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; 
            font-weight: bold; box-shadow: 0 4px 10px rgba(255, 158, 170, 0.3);
        }
        .timeline-item { border-left: 3px solid #FFCDD2; padding-left: 20px; margin-left: 10px; margin-bottom: 25px; position: relative; }
        .timeline-item::before { content: 'ğŸŒ¸'; position: absolute; left: -11px; top: 0; font-size: 1.2rem; background: var(--card-bg); line-height: 1; }
        .detail-card { background: #FFF; border: 1px solid #F0F0F0; border-radius: 12px; padding: 12px; margin-top: 8px; font-size: 0.9rem; }
        .detail-row { display: flex; gap: 8px; margin-bottom: 6px; align-items: flex-start; }
        .detail-icon { color: var(--primary-dark); font-weight: bold; min-width: 20px; }
        
        /* é€£çµæ¨£å¼ */
        a.smart-link { color: #29B6F6; text-decoration: none; font-weight: bold; }
        a.smart-link:hover { text-decoration: underline; }

        /* ç¥¨åˆ¸æ¨£å¼ */
        .ticket-card {
            background: white; border-radius: 15px; padding: 0; overflow: hidden; margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
        }
        .ticket-header { background: var(--primary-color); color: white; padding: 15px; font-weight: bold; font-size: 1.1rem; border-bottom: 3px dashed white; }
        .ticket-body { padding: 15px; }
        .ticket-qr { text-align: center; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 10px; }

        /* è³¼ç‰©æ¸…å–® */
        .shopping-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px dashed #FFCDD2; }
        .shopping-item.checked { opacity: 0.5; }
        .shopping-item.checked .shop-name { text-decoration: line-through; }
        .check-circle { 
            width: 24px; height: 24px; border: 2px solid var(--primary-color); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; margin-right: 12px; cursor: pointer; background: white; flex-shrink: 0;
        }
        .checked .check-circle { background: var(--primary-color); color: white; }
        .shop-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 10px; background: #eee; border: 1px solid #ddd; }

        /* æ€¥é›£æ•‘åŠ© */
        .emergency-section a { color: #E57373; text-decoration: none; font-weight: bold; border-bottom: 2px solid rgba(229, 115, 115, 0.3); }

        /* æ”¶æŠ˜é¸å–® */
        details { margin-bottom: 10px; background: white; border-radius: 15px; border: 1px solid #eee; }
        summary { padding: 12px; cursor: pointer; font-weight: bold; background: #FFF5F7; border-radius: 15px; list-style: none; display: flex; justify-content: space-between; align-items: center;}
        summary::-webkit-details-marker { display: none; }
        summary::after { content: 'ğŸ”½'; font-size: 0.8rem; color: var(--primary-dark); }
        details[open] summary::after { content: 'ğŸ”¼'; }
        .details-content { padding: 15px; border-top: 1px dashed #FFCDD2; }

        /* --- Modal æ¨£å¼ (è³‡æ–™è½‰ç§») --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s;
            text-align: center;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 1.2rem; color: var(--primary-dark); margin-bottom: 15px; font-weight: bold; }
        .modal-desc { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        
        /* å®‰è£æç¤ºæ¢ */
        #install-prompt {
            display: none;
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9999;
            font-size: 0.9rem; border: 2px solid var(--primary-color);
            align-items: center; gap: 10px; width: 90%; max-width: 350px;
        }
    </style>
</head>
<body>

<header>
    <h1>
        <img src="dino.png" class="header-icon" alt="dino">
        2025 å°åŒ—é¼»è·¨å¹´é¦™æ¸¯è¡Œ
        <img src="dino.png" class="header-icon" alt="dino" style="transform: scaleX(-1);">
    </h1>
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
</header>

<!-- å®‰è£æç¤º -->
<div id="install-prompt">
    <span>ğŸ“² åŠ å…¥ä¸»ç•«é¢ï¼Œé›¢ç·šä¹Ÿèƒ½ç”¨ï¼</span>
    <button onclick="installPWA()" style="padding: 5px 15px; font-size: 0.8rem;">å®‰è£</button>
    <button onclick="document.getElementById('install-prompt').style.display='none'" class="outline" style="padding: 5px 10px; border:none; font-size:1.2rem;">Ã—</button>
</div>

<div class="container">
    
    <!-- 1. èˆªç­é é¢ -->
    <div id="page-flights" class="page active">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('flights')" id="btn-edit-flights">âœï¸ ç·¨è¼¯</button></div>
            <div id="view-flights"></div>
            <div id="edit-flights" style="display:none;">
                <h3 class="section-title">ğŸ›« å»ç¨‹ (Outbound)</h3>
                <div id="edit-flights-outbound"></div>
                <h3 class="section-title">ğŸ›¬ å›ç¨‹ (Inbound)</h3>
                <div id="edit-flights-inbound"></div>
                <button onclick="saveData('flights')" class="full-width">ğŸ’¾ å„²å­˜èˆªç­è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- 2. é£¯åº—é é¢ -->
    <div id="page-hotel" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('hotel')" id="btn-edit-hotel">âœï¸ ç·¨è¼¯</button></div>
            <div id="view-hotel"></div>
            <div id="edit-hotel" style="display:none;">
                <div id="hotel-form-container"></div>
                <button class="outline full-width" onclick="addHotel()">+ æ–°å¢é£¯åº—</button>
                <button onclick="saveData('hotel')" class="full-width">ğŸ’¾ å„²å­˜é£¯åº—</button>
            </div>
        </div>
    </div>

    <!-- 3. è¡Œç¨‹é é¢ -->
    <div id="page-itinerary" class="page">
        <div class="edit-controls" style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 15px; margin-bottom: 10px;">
            <button onclick="toggleEdit('itinerary')" id="btn-edit-itinerary">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
        </div>
        <div id="view-itinerary"></div>
        <div id="edit-itinerary" style="display:none;">
            <div id="itinerary-form-container"></div>
            <button class="outline full-width" onclick="addDay()">ğŸ“… æ–°å¢ä¸€å¤© (Day)</button>
            <button onclick="saveData('itinerary')" class="full-width">ğŸ’¾ å„²å­˜æ‰€æœ‰è¡Œç¨‹</button>
        </div>
    </div>

    <!-- 4. æ·é‹é é¢ -->
    <div id="page-mrt" class="page">
        <div class="card">
            <h3>ğŸš‡ é¦™æ¸¯åœ°éµåœ– (MRT)</h3>
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <button onclick="zoomMap(-20)">ğŸ” -</button>
                <button onclick="zoomMap(0)">é‡ç½®</button>
                <button onclick="zoomMap(20)">ğŸ” +</button>
            </div>
            <div style="overflow: auto; border: 2px solid var(--primary-color); border-radius: 15px; height: 60vh; background:white;">
                <img id="mrt-img" src="HongKong_MRT.png" 
                     style="width: 100%; transition: width 0.3s;" alt="è«‹ç¢ºèª HongKong_MRT.png å­˜åœ¨" 
                     onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Hong_Kong_Railway_Route_Map_en.svg/1200px-Hong_Kong_Railway_Route_Map_en.svg.png';this.alt='è¼‰å…¥æœ¬åœ°åœ°åœ–å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨ç·šä¸Šåœ°åœ–'">
            </div>
        </div>
    </div>

    <!-- 5. ç¥¨åˆ¸é é¢ -->
    <div id="page-tickets" class="page">
        <div class="card" style="border:none; background:transparent; box-shadow:none; padding:0;">
            <div class="edit-controls"><button onclick="toggleEdit('tickets')" id="btn-edit-tickets" style="background:white; color:#555;">âœï¸ ç®¡ç†ç¥¨åˆ¸</button></div>
            <div id="view-tickets"></div>
            <div id="edit-tickets" style="display:none;">
                <div class="card">
                    <div id="tickets-form"></div>
                    <button class="outline full-width" onclick="addTicket()">ğŸŸï¸ æ–°å¢ç¥¨åˆ¸</button>
                    <button onclick="saveData('tickets')" class="full-width">ğŸ’¾ å„²å­˜ç¥¨åˆ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. å¿…è²·æ¸…å–® -->
    <div id="page-shopping" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('shopping')" id="btn-edit-shopping">âœï¸ ç·¨è¼¯æ¸…å–®</button></div>
            <div id="view-shopping"></div>
            <div id="edit-shopping" style="display:none;">
                <div id="shopping-form"></div>
                <button class="outline full-width" onclick="addShoppingItem()">ğŸ›ï¸ æ–°å¢å¿…è²·</button>
                <button onclick="saveData('shopping')" class="full-width">ğŸ’¾ å„²å­˜æ¸…å–®</button>
            </div>
        </div>
    </div>

    <!-- 7. ç­†è¨˜é é¢ -->
    <div id="page-notes" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('notes')" id="btn-edit-notes">âœï¸ ç·¨è¼¯ç­†è¨˜</button></div>
            <div id="view-notes"></div>
            <div id="edit-notes" style="display:none;">
                <div id="notes-form"></div>
                <button class="outline full-width" onclick="addNote()">ğŸ“ æ–°å¢ç­†è¨˜</button>
                <button onclick="saveData('notes')" class="full-width">ğŸ’¾ å„²å­˜ç­†è¨˜</button>
            </div>
        </div>
    </div>

    <!-- 8. æ€¥é›£æ•‘åŠ© -->
    <div id="page-emergency" class="page">
        <div class="card emergency-section" style="border-left: 5px solid #EF9A9A;">
            <h3 style="color:#D84315; text-align:center;">ğŸ†˜ æ€¥é›£æ•‘åŠ©</h3>
            
            <h4>ï¼œé€šç”¨ç·Šæ€¥é›»è©±ï¼</h4>
            <p>æ’¥æ‰“ <a href="tel:999">999</a> (è­¦å¯Ÿã€æ¶ˆé˜²ã€æ•‘è­·è»Š)</p>

            <h4>ï¼œé¦™æ¸¯è¾¦äº‹è™•ï¼</h4>
            <p>æ€¥é›£æ•‘åŠ©ï¼š<a href="tel:+85261439012">(852) 6143-9012</a></p>

            <h4>ï¼œé¦™æ¸¯æ—…éŠç™¼å±•å±€ï¼</h4>
            <p>æ—…éŠç†±ç·šï¼š<a href="tel:+85225081234">(852) 2508-1234</a></p>

            <h4>ï¼œé¦™æ¸¯è­¦å‹™è™•ï¼</h4>
            <p>è­¦å¯Ÿç†±ç·šï¼š<a href="tel:+85225277177">(852) 2527-7177</a></p>
        </div>
    </div>
</div>

<!-- è¨­å®š Modal -->
<div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) closeSettings()">
    <div class="modal-content">
        <div class="modal-title">âš™ï¸ è³‡æ–™è½‰ç§»ä¸­å¿ƒ</div>
        <p class="modal-desc">æ‚¨å¯ä»¥å°‡è³‡æ–™å‚™ä»½æˆæª”æ¡ˆï¼Œæˆ–å¾å…¶ä»–è£ç½®åŒ¯å…¥ã€‚</p>
        
        <button class="full-width" onclick="exportData()">ğŸ“¤ ä¸‹è¼‰å‚™ä»½æª” (.json)</button>
        
        <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:15px;">
            <label style="color:#555;">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (é¸æ“‡æª”æ¡ˆ)</label>
            <input type="file" id="import-file" accept=".json" onchange="importData(this)" style="border:2px dashed var(--primary-color);">
        </div>

        <hr style="margin: 15px 0; border: 0.5px dashed #ccc;">
        <button class="danger full-width" onclick="resetApp()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        <button class="outline full-width" style="margin-top:10px;" onclick="closeSettings()">é—œé–‰</button>
    </div>
</div>

<!-- åº•éƒ¨å°èˆª -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('flights', this)">
        <img src="airplane.png" class="nav-icon-img" alt="èˆªç­"><span>èˆªç­</span>
    </div>
    <div class="nav-item" onclick="switchPage('hotel', this)">
        <img src="hotel.png" class="nav-icon-img" alt="é£¯åº—"><span>é£¯åº—</span>
    </div>
    <div class="nav-item" onclick="switchPage('itinerary', this)">
        <img src="liti.png" class="nav-icon-img" alt="è¡Œç¨‹"><span>è¡Œç¨‹</span>
    </div>
    <div class="nav-item" onclick="switchPage('mrt', this)">
        <img src="train.png" class="nav-icon-img" alt="æ·é‹"><span>æ·é‹</span>
    </div>
    <div class="nav-item" onclick="switchPage('tickets', this)">
        <img src="ticket.png" class="nav-icon-img" alt="ç¥¨åˆ¸"><span>ç¥¨åˆ¸</span>
    </div>
    <div class="nav-item" onclick="switchPage('shopping', this)">
        <img src="shoppingbag.png" class="nav-icon-img" alt="å¿…è²·"><span>å¿…è²·</span>
    </div>
    <div class="nav-item" onclick="switchPage('notes', this)">
        <img src="note.png" class="nav-icon-img" alt="ç­†è¨˜"><span>ç­†è¨˜</span>
    </div>
    <div class="nav-item" onclick="switchPage('emergency', this)">
        <img src="SOS.png" class="nav-icon-img" alt="æ±‚åŠ©"><span>æ±‚åŠ©</span>
    </div>
</nav>

<script>
    // --- PWA Service Worker è¨»å†Š ---
    let deferredPrompt;
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker è¨»å†ŠæˆåŠŸ:', reg))
                .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
        });
    }

    // PWA å®‰è£æç¤º
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // å¦‚æœé‚„æ²’å®‰è£ï¼Œé¡¯ç¤ºå®‰è£æŒ‰éˆ•
        document.getElementById('install-prompt').style.display = 'flex';
    });

    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('ä½¿ç”¨è€…æ¥å—å®‰è£');
                }
                deferredPrompt = null;
                document.getElementById('install-prompt').style.display = 'none';
            });
        }
    }

    // --- 1. è³‡æ–™åˆå§‹åŒ– & é˜²å‘†ä¿®å¾© ---
    const defaultData = {
        flights: { 
            outbound: { airline: 'é•·æ¦®èˆªç©º', from:'å°åŒ— TPE', term:'ç¬¬äºŒèˆªå»ˆ', number: 'BR869', date: '2025-12-30', time: '12:25 / 14:20', boardTime:'', gate: '', pnr: '', price:'', note:'', passengers: [{name:'', seat:'50A'}, {name:'', seat:'50B'}, {name:'', seat:'50C'}] }, 
            inbound: { airline: 'é•·æ¦®èˆªç©º', from:'é¦™æ¸¯ HKG', term:'ç¬¬ä¸€èˆªå»ˆ', number: 'BR868', date: '2026-01-03', time: '13:30 / 15:20', boardTime:'', gate: '', pnr: '', price:'', note:'', passengers: [{name:'', seat:'46H'}, {name:'', seat:'46J'}, {name:'', seat:'46K'}] } 
        },
        hotels: [
            { name: 'å¯Œè–ˆå°šä¹˜ä¸Šç’°é…’åº—', address: 'ä¸Šç’°æ–‡å’¸è¥¿è¡—5è™Ÿ', transport:'', checkin:'2025-12-30', checkout:'2025-12-31', voucher:'', photo:'', surroundings:'', notes: 'å•†è–ˆè±ªè¯å®¢æˆ¿ / 1771.54 HK' },
            { name: 'æ¸¯å³¶é¦™æ ¼é‡Œæ‹‰', address: 'ä¸­ç’°æ³•é™¢é“å¤ªå¤å»£å ´', transport:'', checkin:'2025-12-31', checkout:'2026-01-01', voucher:'', photo:'', surroundings:'', notes: 'è±ªè¯æµ·æ™¯ç‰¹å¤§é›™äººåºŠæˆ¿ / 4571.63 HK' },
            { name: 'è¿ªå£«å°¼æ¢ç´¢å®¶åº¦å‡é…’åº—', address: 'é¦™æ¸¯è¿ªå£«å°¼æ¨‚åœ’åº¦å‡å€', transport:'', checkin:'2026-01-01', checkout:'2026-01-02', voucher:'', photo:'', surroundings:'', notes: 'è±ªè¯é›™äººæˆ¿ / 2936.11 HK' },
            { name: 'æ±æ¶Œä¸–èŒ‚å–œä¾†ç™»é…’åº—', address: 'å¤§å¶¼å±±æ±æ¶Œæ€¡æ±è·¯9è™Ÿ', transport:'', checkin:'2026-01-02', checkout:'2026-01-03', voucher:'', photo:'', surroundings:'', notes: 'è±ªè¯ç‰¹å¤§é›™äººæˆ¿ / 1828.70 HK' }
        ],
        itinerary: [
            { 
                date: '2025-12-30', summary: 'å‡ºç™¼ & ä¸Šç’°', 
                items: [
                    { time:'12:25', title:'æ­ä¹˜é•·æ¦® BR869', intro:'å‰å¾€é¦™æ¸¯', transport:'é£›æ©Ÿ', mapUrl:'', hours:'', mustBuy:'', menu:'', voucher:'', photo:'', notes:'' }
                ] 
            }
        ],
        tickets: [],
        shopping: [],
        notes: []
    };

    let appData = JSON.parse(localStorage.getItem('travelAppHK_2025')) || defaultData;

    function checkAndFixData(data) {
        if(!data.flights) data.flights = defaultData.flights;
        if(!data.hotels) data.hotels = defaultData.hotels;
        if(!data.itinerary) data.itinerary = defaultData.itinerary;
        if(!data.tickets) data.tickets = [];
        if(!data.shopping) data.shopping = [];
        if(!data.notes) data.notes = [];
        return data;
    }
    appData = checkAndFixData(appData);

    function saveToLocal() {
        try {
            localStorage.setItem('travelAppHK_2025', JSON.stringify(appData));
            alert('âœ¨ å„²å­˜æˆåŠŸï¼'); 
        } catch(e) {
            alert('âŒ å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯åœ–ç‰‡å¤ªå¤šï¼Œè«‹åˆªé™¤éƒ¨åˆ†ç…§ç‰‡å¾Œå†è©¦ã€‚');
        }
    }

    // --- è³‡æ–™è½‰ç§» (æª”æ¡ˆç‰ˆ) ---
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

    function resetApp() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼ˆå«ç…§ç‰‡ï¼‰ä¸¦æ¢å¾©åŸå» è¨­å®šï¼ç¢ºå®šå—ï¼Ÿ")) {
            localStorage.removeItem('travelAppHK_2025');
            location.reload();
        }
    }

    // åŒ¯å‡ºåŠŸèƒ½ï¼šä¸‹è¼‰ JSON æª”æ¡ˆ
    function exportData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // æª”ååŠ å…¥æ—¥æœŸ
        const date = new Date().toISOString().slice(0,10);
        a.download = `é¦™æ¸¯è·¨å¹´è¡Œå‚™ä»½_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('âœ… å‚™ä»½æª”å·²é–‹å§‹ä¸‹è¼‰ï¼');
    }

    // åŒ¯å…¥åŠŸèƒ½ï¼šè®€å– JSON æª”æ¡ˆ
    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const newData = JSON.parse(content);
                
                // æª¢æŸ¥é—œéµæ¬„ä½
                if(newData.flights && newData.hotels) {
                    if(confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥å°‡æœƒã€Œè¦†è“‹ã€ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                        appData = checkAndFixData(newData);
                        saveToLocal();
                        location.reload();
                    }
                } else {
                    alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œé€™ä¸æ˜¯æœ¬ App çš„å‚™ä»½æª”ã€‚");
                }
            } catch (err) {
                alert("âŒ è®€å–å¤±æ•—ï¼Œæª”æ¡ˆå¯èƒ½å·²æå£ã€‚");
                console.error(err);
            }
            input.value = ''; // æ¸…ç©ºä»¥åˆ©ä¸‹æ¬¡é¸æ“‡
        };
        reader.readAsText(file);
    }

    // --- 2. æ™ºæ…§å¤šåª’é«”è™•ç† (åœ–ç‰‡å£“ç¸®) ---
    function handleImageUpload(input, callback) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const maxWidth = 800; // ç¨å¾®æé«˜è§£æåº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                };
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    // --- 3. æ™ºæ…§é€£çµè¾¨è­˜ ---
    function formatContent(text) {
        if (!text) return '';
        if (text.match(/\.(jpeg|jpg|gif|png)$/i) != null) {
            return `<img src="${text}" class="preview-img" onclick="window.open(this.src)">`;
        }
        if (text.match(/^http/i)) {
            return `<a href="${text}" target="_blank" class="smart-link">ğŸ”— é–‹å•Ÿé€£çµ</a>`;
        }
        return text;
    }

    // --- 4. é é¢åˆ‡æ› ---
    function switchPage(pageId, navEl) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        renderView(pageId);
    }

    function toggleEdit(section) {
        const v = document.getElementById(`view-${section}`);
        const e = document.getElementById(`edit-${section}`);
        const btn = document.getElementById(`btn-edit-${section}`);
        
        if (e.style.display === 'none') {
            e.style.display = 'block'; v.style.display = 'none';
            btn.innerText = 'ğŸ‘€ è¿”å›æª¢è¦–';
        } else {
            e.style.display = 'none'; v.style.display = 'block';
            btn.innerText = 'âœï¸ ç·¨è¼¯æ¨¡å¼';
        }
        renderView(section);
    }

    // --- 5. æ¸²æŸ“é‚è¼¯ ---
    const renderers = {
        flights: () => {
            const fCols = { airline:'èˆªç©ºå…¬å¸', from:'å‡ºç™¼åœ°', term:'èˆªå»ˆ', number:'ç­è™Ÿ', date:'æ—¥æœŸ', time:'èµ·é£›/æŠµé”', boardTime:'ç™»æ©Ÿæ™‚é–“', gate:'ç™»æ©Ÿé–€', pnr:'è¨‚ä½ä»£è™Ÿ', price:'ç¥¨åƒ¹', note:'å‚™è¨»' };
            
            const genView = (title, d) => {
                let html = `<div class="card" style="border-left:5px solid var(--primary-color);"><h4>${title}</h4>`;
                for(let k in fCols) if(d[k]) html += `<div class="info-row"><span class="info-label">${fCols[k]}</span><span class="info-value">${d[k]}</span></div>`;
                html += `<div class="info-row"><span class="info-label">æ—…å®¢</span><span class="info-value">` + 
                        (d.passengers||[]).map(p=>`${p.name} (${p.seat})`).join('<br>') + `</span></div></div>`;
                return html;
            };
            document.getElementById('view-flights').innerHTML = genView('ğŸ›« å»ç¨‹', appData.flights.outbound) + genView('ğŸ›¬ å›ç¨‹', appData.flights.inbound);

            const genEdit = (type, d) => {
                let h = `<div class="edit-group">`;
                for(let k in fCols) h += `<label>${fCols[k]}</label><input value="${d[k]||''}" onchange="appData.flights.${type}.${k}=this.value">`;
                h += `<label>æ—…å®¢ (å§“å / åº§ä½)</label><div id="pax-${type}">`;
                (d.passengers||[]).forEach((p,i) => {
                    h += `<div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input placeholder="å§“å" value="${p.name}" onchange="appData.flights.${type}.passengers[${i}].name=this.value">
                        <input placeholder="åº§ä½" value="${p.seat}" onchange="appData.flights.${type}.passengers[${i}].seat=this.value">
                        <button class="danger icon-btn" onclick="removePax('${type}',${i})">ğŸ—‘ï¸</button>
                    </div>`;
                });
                h += `</div><button class="outline full-width" onclick="addPax('${type}')">+ æ–°å¢æ—…å®¢</button></div>`;
                return h;
            };
            document.getElementById('edit-flights-outbound').innerHTML = genEdit('outbound', appData.flights.outbound);
            document.getElementById('edit-flights-inbound').innerHTML = genEdit('inbound', appData.flights.inbound);
        },
        hotel: () => {
            document.getElementById('view-hotel').innerHTML = appData.hotels.map((h, i) => `
                <div class="card">
                    <h3 style="color:var(--primary-dark);">${h.name}</h3>
                    <div class="info-row"><span class="info-label">åœ°å€</span><span class="info-value"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}" target="_blank" class="smart-link">${h.address}</a></span></div>
                    <div class="info-row"><span class="info-label">å…¥ä½/é€€æˆ¿</span><span class="info-value">${h.checkin} ~ ${h.checkout}</span></div>
                    <div class="info-row"><span class="info-label">å‚™è¨»/åƒ¹æ ¼</span><span class="info-value" style="color:#E91E63; font-weight:bold;">${h.notes}</span></div>
                    <div class="detail-card">
                        ${h.voucher ? `<div><b>æ†‘è­‰ï¼š</b>${formatContent(h.voucher)}</div>` : ''}
                        ${h.photo ? `<img src="${h.photo}" class="preview-img" onclick="window.open(this.src)">` : ''}
                    </div>
                </div>`).join('');
            
            const fields = { name:'é£¯åº—åç¨±', address:'åœ°å€', transport:'äº¤é€š', checkin:'å…¥ä½', checkout:'é€€æˆ¿', voucher:'æ†‘è­‰(ç¶²å€/æ–‡å­—)', photo:'ç…§ç‰‡(ç¶²å€)', surroundings:'é€±é‚Š', notes:'å‚™è¨»/åƒ¹æ ¼' };
            document.getElementById('hotel-form-container').innerHTML = appData.hotels.map((h, idx) => `
                <div class="edit-group">
                    <button class="delete-btn-corner" onclick="removeHotel(${idx})">âŒ</button>
                    <h4>é£¯åº— ${idx+1}</h4>
                    ${Object.entries(fields).map(([k,l]) => {
                        if(k==='photo') return `
                            <label>${l}</label>
                            <div class="upload-btn-wrapper">
                                <button class="outline full-width">ğŸ“· ä¸Šå‚³ç…§ç‰‡ (è‡ªå‹•å£“ç¸®)</button>
                                <input type="file" accept="image/*" onchange="handleImageUpload(this, (b64)=>{ appData.hotels[${idx}].photo=b64; renderView('hotel'); })">
                            </div>
                            ${h.photo ? `<img src="${h.photo}" style="width:60px; height:60px; object-fit:cover; margin-top:5px;">` : ''}
                        `;
                        return `<label>${l}</label><input value="${h[k]||''}" onchange="appData.hotels[${idx}].${k}=this.value">`;
                    }).join('')}
                </div>`).join('');
        },
        itinerary: () => {
            document.getElementById('view-itinerary').innerHTML = appData.itinerary.map(d => `
                <div class="day-header"><span>${d.date}</span><span>${d.summary}</span></div>
                ${d.items.map(i => {
                    const gMap = i.title ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.title + ' é¦™æ¸¯')}` : '';
                    return `
                    <div class="timeline-item">
                        <div style="font-weight:bold; color:var(--text-color); font-size:1.05rem;">${i.time} ${i.title}</div>
                        <div style="color:#666; font-size:0.9rem; margin-bottom:5px;">${i.intro||''}</div>
                        
                        <div class="detail-card">
                            ${i.transport ? `<div class="detail-row"><span class="detail-icon">ğŸšŒ</span> ${i.transport}</div>` : ''}
                            ${i.hours ? `<div class="detail-row"><span class="detail-icon">ğŸ•’</span> ${i.hours}</div>` : ''}
                            ${i.mustBuy ? `<div class="detail-row"><span class="detail-icon">ğŸ›ï¸</span> å¿…è²·: ${i.mustBuy}</div>` : ''}
                            ${i.menu ? `<div class="detail-row"><span class="detail-icon">ğŸ´</span> æ¨è–¦: ${i.menu}</div>` : ''}
                            ${gMap ? `<a href="${gMap}" target="_blank" class="smart-link" style="display:block; margin-top:5px;">ğŸ“ é»é–‹ Google Maps</a>` : ''}
                            ${i.photo ? `<img src="${i.photo}" class="preview-img" onclick="window.open(this.src)">` : ''}
                        </div>
                    </div>`;
                }).join('')}
            `).join('');

            const iFields = { time:'æ™‚é–“', title:'æ¨™é¡Œ', intro:'ä»‹ç´¹', transport:'äº¤é€š', hours:'ç‡Ÿæ¥­æ™‚é–“', mustBuy:'å¿…è²·', menu:'æ¨è–¦èœå–®', voucher:'æ†‘è­‰è™Ÿ', notes:'å‚™è¨»' };
            document.getElementById('itinerary-form-container').innerHTML = appData.itinerary.map((d, dIdx) => `
                <div class="edit-group" style="border:2px solid var(--primary-color);">
                    <button class="delete-btn-corner" onclick="removeDay(${dIdx})">âŒ</button>
                    <label>Day ${dIdx+1} æ—¥æœŸ</label><input type="date" value="${d.date}" onchange="appData.itinerary[${dIdx}].date=this.value">
                    <label>ç•¶æ—¥ç°¡è¿°</label><input value="${d.summary}" onchange="appData.itinerary[${dIdx}].summary=this.value">
                    <hr style="border-top:1px dashed #ccc; margin:15px 0;">
                    <div id="day-${dIdx}-items">
                        ${d.items.map((item, iIdx) => `
                            <details>
                                <summary>${item.time||'--:--'} ${item.title||'æ–°é …ç›®'} <span onclick="removeItm(${dIdx}, ${iIdx})" style="color:red; margin-left:10px;">ğŸ—‘ï¸</span></summary>
                                <div class="details-content">
                                    ${Object.entries(iFields).map(([k,l]) => `<label>${l}</label><input value="${item[k]||''}" onchange="appData.itinerary[${dIdx}].items[${iIdx}].${k}=this.value">`).join('')}
                                    <label>ç…§ç‰‡ (ä¸Šå‚³)</label>
                                    <div class="upload-btn-wrapper">
                                        <button class="outline full-width">ğŸ“· ä¸Šå‚³ç…§ç‰‡</button>
                                        <input type="file" accept="image/*" onchange="handleImageUpload(this, (b64)=>{ appData.itinerary[${dIdx}].items[${iIdx}].photo=b64; saveData('itinerary'); })">
                                    </div>
                                    ${item.photo ? `<img src="${item.photo}" style="width:50px; height:50px; object-fit:cover; margin-top:5px;">` : ''}
                                </div>
                            </details>
                        `).join('')}
                    </div>
                    <button class="secondary full-width" onclick="addItm(${dIdx})">+ æ–°å¢è¡Œç¨‹é …ç›®</button>
                </div>
            `).join('');
        },
        tickets: () => {
            document.getElementById('view-tickets').innerHTML = appData.tickets.map(t => `
                <div class="ticket-card">
                    <div class="ticket-header">${t.name}</div>
                    <div class="ticket-body">
                        <div class="info-row"><span class="info-label">æ—¥æœŸ</span><span class="info-value">${t.date}</span></div>
                        <div class="info-row"><span class="info-label">æ™‚é–“</span><span class="info-value">${t.time}</span></div>
                        <div class="info-row"><span class="info-label">åœ°é»</span><span class="info-value">${t.location}</span></div>
                        <div class="info-row"><span class="info-label">åƒ¹æ ¼</span><span class="info-value">æˆäºº$${t.priceAdult} / å…’ç«¥$${t.priceChild}</span></div>
                        ${t.qrImage ? `<div class="ticket-qr"><p>æ†‘è­‰ (é»æ“Šæ”¾å¤§)</p><img src="${t.qrImage}" style="width:100%; max-width:200px;" onclick="window.open(this.src)"></div>` : '<div style="text-align:center; color:#ccc; padding:10px;">ç„¡æ†‘è­‰åœ–</div>'}
                    </div>
                </div>
            `).join('');

            document.getElementById('tickets-form').innerHTML = appData.tickets.map((t, i) => `
                <div class="edit-group">
                    <button class="delete-btn-corner" onclick="removeArr('tickets', ${i})">âŒ</button>
                    <label>ç¥¨åˆ¸åç¨±</label><input value="${t.name}" onchange="appData.tickets[${i}].name=this.value">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>æ—¥æœŸ</label><input type="date" value="${t.date}" onchange="appData.tickets[${i}].date=this.value"></div>
                        <div style="flex:1"><label>æ™‚é–“</label><input value="${t.time}" onchange="appData.tickets[${i}].time=this.value"></div>
                    </div>
                    <label>åœ°é»</label><input value="${t.location}" onchange="appData.tickets[${i}].location=this.value">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>æˆäººåƒ¹</label><input value="${t.priceAdult}" onchange="appData.tickets[${i}].priceAdult=this.value"></div>
                        <div style="flex:1"><label>å…’ç«¥åƒ¹</label><input value="${t.priceChild}" onchange="appData.tickets[${i}].priceChild=this.value"></div>
                    </div>
                    <label>æ†‘è­‰/QR Code åœ–ç‰‡</label>
                    <div class="upload-btn-wrapper">
                        <button class="secondary full-width">ğŸ“· ä¸Šå‚³æ†‘è­‰</button>
                        <input type="file" accept="image/*" onchange="handleImageUpload(this, (b64)=>{ appData.tickets[${i}].qrImage=b64; renderView('tickets'); })">
                    </div>
                    ${t.qrImage ? `<img src="${t.qrImage}" style="width:100px; margin-top:5px; border:1px solid #ccc;">` : ''}
                </div>
            `).join('');
        },
        shopping: () => {
            const grouped = {};
            appData.shopping.forEach(s => {
                const cat = s.category || 'æœªåˆ†é¡';
                if(!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(s);
            });

            let html = '';
            for(let cat in grouped) {
                html += `<h4 style="color:var(--primary-dark); margin-top:20px; border-bottom:2px solid #FFCDD2;">ğŸ›ï¸ ${cat}</h4>`;
                html += grouped[cat].map(s => {
                    const idx = appData.shopping.indexOf(s);
                    return `
                    <div class="shopping-item ${s.done ? 'checked' : ''}">
                        <div class="check-circle" onclick="toggleShopCheck(${idx})">${s.done ? 'âœ”' : ''}</div>
                        ${s.photo ? `<img src="${s.photo}" class="shop-thumb" onclick="window.open(this.src)">` : ''}
                        <div style="flex-grow:1;">
                            <div class="shop-name" style="font-weight:bold; font-size:1rem;">${s.item}</div>
                            <div style="font-size:0.85rem; color:#666;">ğŸ“ ${s.location} | ğŸ’° HK$${s.price}</div>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('view-shopping').innerHTML = html || '<p style="text-align:center; color:#999;">è³¼ç‰©æ¸…å–®æ˜¯ç©ºçš„ï¼Œå¿«å»æ–°å¢ï¼</p>';

            document.getElementById('shopping-form').innerHTML = appData.shopping.map((s, i) => `
                <div class="edit-group">
                    <button class="delete-btn-corner" onclick="removeArr('shopping', ${i})">âŒ</button>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>åˆ†é¡</label><input list="cats" value="${s.category||''}" onchange="appData.shopping[${i}].category=this.value" placeholder="å¦‚: ä¼´æ‰‹ç¦®"></div>
                        <div style="flex:2"><label>å“é …</label><input value="${s.item}" onchange="appData.shopping[${i}].item=this.value"></div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1"><label>é ä¼°åƒ¹æ ¼</label><input value="${s.price}" onchange="appData.shopping[${i}].price=this.value"></div>
                        <div style="flex:2"><label>åœ°é»</label><input value="${s.location}" onchange="appData.shopping[${i}].location=this.value"></div>
                    </div>
                    <label>åœ–ç‰‡</label>
                    <div class="upload-btn-wrapper"><button class="outline full-width">ğŸ“· ä¸Šå‚³åœ–ç‰‡</button><input type="file" accept="image/*" onchange="handleImageUpload(this, (b64)=>{appData.shopping[${i}].photo=b64; renderView('shopping');})"></div>
                    ${s.photo ? `<img src="${s.photo}" style="width:50px;">` : ''}
                </div>
            `).join('');
        },
        notes: () => {
            document.getElementById('view-notes').innerHTML = appData.notes.map(n => `
                <div class="card" style="background:#FFFDE7;">
                    <b style="color:var(--primary-dark);">${n.date}</b>
                    <div style="white-space:pre-wrap; margin-top:10px; line-height:1.6;">${formatContent(n.content)}</div>
                    ${n.photo ? `<img src="${n.photo}" class="preview-img" onclick="window.open(this.src)">` : ''}
                </div>
            `).join('');
            
            document.getElementById('notes-form').innerHTML = appData.notes.map((n, i) => `
                <div class="edit-group">
                    <button class="delete-btn-corner" onclick="removeArr('notes', ${i})">âŒ</button>
                    <label>æ—¥æœŸ/æ¨™é¡Œ</label><input value="${n.date}" onchange="appData.notes[${i}].date=this.value">
                    <label>å…§å®¹</label><textarea onchange="appData.notes[${i}].content=this.value">${n.content}</textarea>
                    <label>ç…§ç‰‡</label>
                    <div class="upload-btn-wrapper"><button class="full-width outline">ğŸ“· æ’å…¥ç…§ç‰‡</button><input type="file" accept="image/*" onchange="handleImageUpload(this, (b64)=>{appData.notes[${i}].photo=b64; renderView('notes');})"></div>
                    ${n.photo ? `<img src="${n.photo}" style="width:60px; height:60px; object-fit:cover; margin-top:5px;">` : ''}
                </div>
            `).join('');
        }
    };

    function renderView(section) { if(renderers[section]) renderers[section](); }

    /* é€šç”¨æ“ä½œå‡½æ•¸ */
    function addPax(type) { appData.flights[type].passengers.push({name:'', seat:''}); renderView('flights'); }
    function removePax(type, idx) { appData.flights[type].passengers.splice(idx, 1); renderView('flights'); }
    function addHotel() { appData.hotels.push({name:'', address:'', checkin:'', checkout:'', notes:''}); renderView('hotel'); }
    function removeHotel(i) { if(confirm('åˆªé™¤ï¼Ÿ')) { appData.hotels.splice(i,1); renderView('hotel'); } }
    function addDay() { appData.itinerary.push({date:'', summary:'', items:[]}); renderView('itinerary'); }
    function removeDay(i) { if(confirm('åˆªé™¤æ•´å¤©ï¼Ÿ')) { appData.itinerary.splice(i,1); renderView('itinerary'); } }
    function addItm(dIdx) { appData.itinerary[dIdx].items.push({}); renderView('itinerary'); }
    function removeItm(dIdx, iIdx) { appData.itinerary[dIdx].items.splice(iIdx, 1); renderView('itinerary'); }
    function addTicket() { appData.tickets.push({name:'', date:'', time:'', location:'', priceAdult:'', priceChild:''}); renderView('tickets'); }
    function addShoppingItem() { appData.shopping.push({category:'', item:'', price:'', location:'', done:false}); renderView('shopping'); }
    function addNote() { appData.notes.push({date: new Date().toISOString().split('T')[0], content:''}); renderView('notes'); }
    function removeArr(key, idx) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData[key].splice(idx, 1); renderView(key); } }
    function toggleShopCheck(idx) { appData.shopping[idx].done = !appData.shopping[idx].done; saveToLocal(); renderView('shopping'); }

    /* åœ°åœ–ç¸®æ”¾ */
    let mapScale = 100;
    function zoomMap(delta) {
        if(delta === 0) mapScale = 100; else mapScale += delta;
        if(mapScale < 100) mapScale = 100;
        document.getElementById('mrt-img').style.width = mapScale + '%';
    }

    /* åˆå§‹åŒ– */
    document.addEventListener('DOMContentLoaded', () => { 
        renderView('flights'); 
        const dl = document.createElement('datalist'); dl.id='cats';
        ['ä¼´æ‰‹ç¦®','è—¥å¦','æœé£¾','é›¶é£Ÿ','ç²¾å“'].forEach(c=>{const op=document.createElement('option');op.value=c;dl.appendChild(op);});
        document.body.appendChild(dl);
    });
</script>

</body>
</html>